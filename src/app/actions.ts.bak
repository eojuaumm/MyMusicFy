'use server'

import { db } from "@/lib/db";
import { revalidatePath } from "next/cache";
import { hash } from "bcryptjs";
import { redirect } from "next/navigation";


export async function buscarVideosYoutube(termo: string) {
  const apiKey = process.env.YOUTUBE_API_KEY;
  if (!apiKey) return [];

  
  const url = `https:
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.items) {
      
      return data.items.map((video: any) => ({
        id: video.id.videoId,
        titulo: video.snippet.title, 
        canal: video.snippet.channelTitle, 
        capaUrl: video.snippet.thumbnails.high.url,
        ano: new Date(video.snippet.publishedAt).getFullYear(),
        previewUrl: `https:
      }));
    }
  } catch (error) {
    console.error("Erro no YouTube:", error);
  }
  return [];
}


export async function salvarMusicaEscolhida(video: any) {
  await db.musica.create({
    data: {
      titulo: video.titulo,
      artista: video.canal, 
      album: "YouTube",
      ano: video.ano,
      capaUrl: video.capaUrl,
      previewUrl: video.previewUrl,
    },
  });

  revalidatePath("/");
}


export async function registrarUsuario(formData: FormData) {
  const nome = formData.get("nome") as string;
  const email = formData.get("email") as string;
  const password = formData.get("password") as string;

  const userJaExiste = await db.user.findUnique({ where: { email } });
  if (userJaExiste) return;

  const passwordHash = await hash(password, 12);

  await db.user.create({
    data: { nome, email, password: passwordHash }
  });
  redirect("/");
}

export async function removerMusica(id: number) {
  await db.musica.delete({ where: { id } });
  revalidatePath("/");
}

export async function toggleFavorito(id: number) {
  const musica = await db.musica.findUnique({ where: { id } });
  if (musica) {
    await db.musica.update({
      where: { id },
      data: { favorito: !musica.favorito }
    });
  }
  revalidatePath("/");
}

export async function atualizarPerfil(formData: FormData) {
  const emailAtual = formData.get("emailAtual") as string;
  const nome = formData.get("nome") as string;
  const imagem = formData.get("imagem") as string;
  const novaSenha = formData.get("novaSenha") as string;

  let dadosParaAtualizar: any = { nome, imagem };

  if (novaSenha && novaSenha.length > 0) {
    const senhaHash = await hash(novaSenha, 12);
    dadosParaAtualizar.password = senhaHash;
  }

  await db.user.update({
    where: { email: emailAtual },
    data: dadosParaAtualizar
  });

  revalidatePath("/");
  revalidatePath("/perfil");
}



export async function adicionarMusica(formData: FormData) {
  
}

export async function criarPlaylist(formData: FormData) {
  const nome = formData.get("nome") as string;
  
  
  
  const emailUser = formData.get("emailUser") as string;
  
  const user = await db.user.findUnique({ where: { email: emailUser } });
  
  if (user) {
    await db.playlist.create({
      data: {
        nome,
        userId: user.id
      }
    });
    revalidatePath("/playlists");
  }
}

export async function apagarPlaylist(id: number) {
  await db.playlist.delete({ where: { id } });
  revalidatePath("/playlists");
}


export async function adicionarMusicaNaPlaylist(musicaId: number, playlistId: number) {
  await db.playlist.update({
    where: { id: playlistId },
    data: {
      musicas: {
        connect: { id: musicaId }
      }
    }
  });
  revalidatePath("/");
  revalidatePath("/playlists");
}

export async function alternarPlano(email: string) {
  
  const user = await db.user.findUnique({ where: { email } });
  
  if (user) {
    
    await db.user.update({
      where: { email },
      data: { isPro: !user.isPro }
    });
  }
  
  revalidatePath("/");
  revalidatePath("/perfil");
}